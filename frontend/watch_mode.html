<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Watch Mode</title>
  <link rel="stylesheet" href="/static/css/dashboard.css">
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
</head>
<body class="dark">
  <main class="container narrow">
    <section class="card">
      <div class="card-header">
        <div>
          <h2>Watch Mode</h2>
          <p class="muted">Simulating wearable device transmission — auto-sends current values every 5s</p>
        </div>
        <div class="transmissions muted" id="txCount">Transmissions: 0</div>
      </div>

      <div class="device-info">
        <div class="device-id" id="deviceId">WATCH-ABC123</div>
        <div class="tx-status" id="txStatus">Idle</div>
      </div>

      <div class="form-grid">
        <label>Device ID<input id="watch_id" value="WATCH-ABC123"></label>
        <label>Heart Rate (bpm)<input id="heart_rate" type="number" value="78"></label>
        <label>Blood Pressure (s/d)<input id="blood_pressure" value="122/78"></label>
        <label>Respiratory Rate (bpm)<input id="respiratory_rate" type="number" value="16"></label>
        <label>SpO2 (%)<input id="spo2" type="number" value="97"></label>
        <label>Body Temperature (°C)<input id="temperature" step="0.1" type="number" value="36.6"></label>
        <label>CO Level (ppm)<input id="co_level" step="0.01" type="number" value="0.50"></label>
        <label>Oxygen Level (%)<input id="oxygen_level" step="0.1" type="number" value="20.9"></label>
      </div>

      <div class="controls">
        <button id="btnSend" class="btn">Send Now</button>
        <button id="btnRandom" class="btn outline">Random Fill</button>
      </div>

      <div id="alertBox" class="alert-box hidden"><strong>Alert Triggered</strong><div id="alertMsg">One or more parameters exceed safe thresholds</div></div>

      <h3>Live Preview</h3>
      <pre id="preview">No data yet</pre>
    </section>
  </main>

<script>
const socket = io();
let tx = 0;
const watchIdEl = document.getElementById('watch_id');
const deviceIdEl = document.getElementById('deviceId');
const txStatus = document.getElementById('txStatus');
const txCount = document.getElementById('txCount');
const preview = document.getElementById('preview');
const alertBox = document.getElementById('alertBox');
const alertMsg = document.getElementById('alertMsg');

function getPayload(){
  return {
    watch_id: watchIdEl.value || 'WATCH-000',
    heart_rate: Number(document.getElementById('heart_rate').value),
    blood_pressure: document.getElementById('blood_pressure').value,
    respiratory_rate: Number(document.getElementById('respiratory_rate').value),
    spo2: Number(document.getElementById('spo2').value),
    temperature: Number(document.getElementById('temperature').value),
    co_level: Number(document.getElementById('co_level').value),
    oxygen_level: Number(document.getElementById('oxygen_level').value)
  };
}

async function sendNow(){
  const payload = getPayload();
  try{
    const res = await fetch('/upload_data', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
    const j = await res.json();
    tx++;
    txCount.innerText = 'Transmissions: ' + tx;
    txStatus.innerText = 'Last sent: ' + j.timestamp;
    preview.innerText = JSON.stringify(payload, null, 2);
    deviceIdEl.innerText = payload.watch_id;
    // show alerts visually
    const alerts = [];
    if (payload.heart_rate < 55 || payload.heart_rate > 110) alerts.push('Abnormal heart rate');
    if (payload.spo2 < 90) alerts.push('Low SpO2');
    if (payload.co_level > 9) alerts.push('High CO Exposure');
    if (alerts.length){
      alertBox.classList.remove('hidden');
      alertMsg.innerHTML = alerts.join('<br>');
    } else {
      alertBox.classList.add('hidden');
    }
  } catch(e){
    txStatus.innerText = 'Send failed';
  }
}

document.getElementById('btnSend').addEventListener('click', sendNow);
document.getElementById('btnRandom').addEventListener('click', ()=>{
  document.getElementById('heart_rate').value = 60 + Math.floor(Math.random()*50);
  document.getElementById('blood_pressure').value = (110+Math.floor(Math.random()*30)) + '/' + (65+Math.floor(Math.random()*25));
  document.getElementById('respiratory_rate').value = 12 + Math.floor(Math.random()*10);
  document.getElementById('spo2').value = 92 + Math.floor(Math.random()*8);
  document.getElementById('temperature').value = (36 + Math.random()*2).toFixed(1);
  document.getElementById('co_level').value = (Math.random()*25).toFixed(2);
  document.getElementById('oxygen_level').value = (19 + Math.random()*2).toFixed(1);
});

// auto-send current inputs every 5s (manual values)
setInterval(sendNow, 5000);

// subscribe to socket for live preview updates
socket.on('new_data', (data) => {
  preview.innerText = JSON.stringify(data, null, 2);
});
</script>
</body>
</html>